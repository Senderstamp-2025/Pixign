name: Auto PR

on:
  pull_request:
    types: [opened, reopened, ready_for_review, closed]
    branches:
      - release
      - develop
      - main

jobs:
  pr_automation:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      # 1. Assigneesì— ìê¸° ìì‹  ìë™ ì„¤ì • (PR ìƒì„±ì)
      - name: Auto-assign issue creator to PR
        if: github.event.action == 'opened' || github.event.action == 'reopened' || github.event.action == 'ready_for_review'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const prCreator = context.actor;
            console.log(`Assigning ${prCreator} to PR #${prNumber}`);
            await github.rest.issues.addAssignees({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              assignees: [prCreator]
            });

      # 2. Reviewersì— íŠ¹ì • íŒ€ì› ìë™ ì„¤ì •
      - name: Request reviews from specific team members
        if: github.event.action == 'opened' || github.event.action == 'reopened' || github.event.action == 'ready_for_review'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const reviewers = ['Da-Yeon-Kim', '202780'];
            console.log(`Requesting reviews from ${reviewers.join(', ')} for PR #${prNumber}`);
            try {
              await github.rest.pulls.requestReviewers({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                reviewers: reviewers
              });
            } catch (error) {
              console.error(`Failed to request reviewers: ${error.message}`);
            }

      # 3. ì œëª©ì— ë”°ë¼ Labels ìë™ ì„¤ì •
      - name: Auto-label based on PR title
        if: github.event.action == 'opened' || github.event.action == 'reopened' || github.event.action == 'ready_for_review'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const prTitle = context.payload.pull_request.title;
            const labelsToAdd = [];

            if (prTitle.startsWith('[FEAT]')) {
              labelsToAdd.push('âœ¨ Feature');
            } else if (prTitle.startsWith('[FIX]')) {
              labelsToAdd.push('ğŸ BugFix');
            } else if (prTitle.startsWith('[DOCS]')) {
              labelsToAdd.push('ğŸ“ƒ Docs');
            } else if (prTitle.includes('[REFACTOR]')) {
              labelsToAdd.push('ğŸ”¨ Refactor');
            } else if (prTitle.includes('[TEST]')) {
              labelsToAdd.push('âœ… Test');
            } else if (prTitle.includes('[CHORE]')) {
              labelsToAdd.push('âš™ï¸ Setting);
            }

            if (labelsToAdd.length > 0) {
              console.log(`Adding labels: ${labelsToAdd.join(', ')} to PR #${prNumber}`);
              try {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  labels: labelsToAdd
                });
              } catch (error) {
                console.error(`Failed to add labels: ${error.message}`);
              }
            } else {
              console.log('No matching title pattern found for labels.');
            }

      # 4. close #ì´ìŠˆë²ˆí˜¸ ë¡œ ì´ìŠˆ ìë™ ë‹«ê¸° (develop ë¸Œëœì¹˜ ë³‘í•© ì‹œ)
      - name: Close linked issue on PR merge
        if: github.event.pull_request.merged == true
        uses: actions/github-script@v7
        with:
          script: |
            const prBody = context.payload.pull_request.body;
            const prTitle = context.payload.pull_request.title;
            const regex = /(?:close|closes|closed|fix|fixes|fixed|resolve|resolves|resolved)\s+#(\d+)/i;

            let issueNumber = null;

            let match = prBody.match(regex);
            if (match && match[1]) {
              issueNumber = match[1];
            }

            if (issueNumber) {
              console.log(`Found issue number: ${issueNumber}. Attempting to close it.`);
              try {
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  state: 'closed'
                });
                console.log(`Successfully closed issue #${issueNumber}`);
              } catch (error) {
                console.error(`Failed to close issue #${issueNumber}:`, error.message);
              }
            } else {
              console.log('No closing keyword found in PR body or title. Issue will not be closed automatically.');
            }
